<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Satsang Dashboard by Day</title>
    <?
      // Define global variables for special satsangs
      var _specialData = typeof specialData !== 'undefined' ? specialData : null;
      var _headers = typeof specialEventTableHeaders !== 'undefined' ? specialEventTableHeaders : null;
      var _keys = typeof specialEventTableKeys !== 'undefined' ? specialEventTableKeys : null;
      var _displayMonth = selectedMonth;
      try { 
        var parts = selectedMonth.split('-'); 
        var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); 
        _displayMonth = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }); 
      } catch(e) {}
    ?>
    <style>
      /* Modern Color Scheme and Base Styles */
      :root {
        --primary-color: #8B0000;
        --secondary-color: #A52A2A;
        --accent-color: #B22222;
        --background-color: #f8f9fa;
        --text-color: #2c3e50;
        --border-color: #e0e0e0;
        --success-color: #4CAF50;
        --error-color: #f44336;
        --tab-active-bg: #fff;
        --tab-inactive-bg: #f0f0f0;
        --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
        --transition-speed: 0.3s;
      }

      body { 
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
        font-size: 14px; 
        line-height: 1.5;
        margin: 0;
        padding: 20px;
        background-color: var(--background-color);
        color: var(--text-color);
      }

      /* Header Styles */
      h1 { 
        color: var(--primary-color);
        margin-bottom: 24px;
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      h2 { 
        background-color: var(--primary-color);
        color: white;
        padding: 16px 24px;
        margin: 0;
        border-radius: 8px 8px 0 0;
        font-size: 20px;
        font-weight: 500;
      }

      /* Controls Section */
      .controls {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        margin-bottom: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .controls label {
        font-weight: 500;
        color: var(--text-color);
        margin-right: 8px;
      }

      .controls select {
        padding: 10px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        min-width: 180px;
        background-color: white;
        cursor: pointer;
        transition: border-color var(--transition-speed);
      }

      .controls select:hover {
        border-color: var(--primary-color);
      }

      .controls select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
      }

      .controls button {
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all var(--transition-speed);
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .controls button:hover {
        background-color: var(--secondary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }

      .controls button:active {
        transform: translateY(0);
      }

      .controls button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Loading Spinner */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Tab Navigation */
      .tab-navigation {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        background: white;
        padding: 8px;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
      }

      .tab-button {
        padding: 12px 24px;
        background-color: var(--tab-inactive-bg);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        font-weight: 500;
        color: var(--text-color);
        transition: all var(--transition-speed);
        flex: 1;
        text-align: center;
      }

      .tab-button.active {
        background-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
      }

      .tab-button:hover:not(.active) {
        background-color: #e8e8e8;
      }

      .tab-content {
        display: none;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        animation: fadeIn var(--transition-speed);
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .tab-content.active {
        display: block;
      }

      /* Table Styles */
      .table-container {
        overflow-x: auto;
        margin: 0;
        padding: 0;
        border-radius: 12px;
        background: white;
      }

      table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        margin: 0;
        background: white;
      }

      th, td {
        border: 1px solid var(--border-color);
        padding: 12px 16px;
        text-align: center;
        vertical-align: middle;
      }

      th {
        background-color: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
      }

      /* Date Separator */
      .date-separator {
        border-left: 3px solid var(--primary-color);
      }

      /* Sticky Headers */
      .date-header {
        background-color: var(--primary-color);
        color: white;
        font-weight: 500;
        position: sticky;
        top: 0;
        z-index: 11;
      }

      .sub-header {
        background-color: #f8f9fa;
        position: sticky;
        top: 40px;
        z-index: 10;
      }

      /* Sticky Columns */
      th.sn-header, td.sn-cell {
        position: sticky;
        left: 0;
        z-index: 12;
        background-color: white;
        min-width: 40px;
      }

      th.avg-header, td.avg-cell {
        position: sticky;
        left: 40px;
        z-index: 12;
        background-color: white;
        min-width: 80px;
      }

      th.centre-header, td.centre-cell {
        position: sticky;
        left: 120px;
        z-index: 12;
        background-color: white;
        min-width: 130px;
      }

      /* Row Styles */
      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }

      tbody tr:hover {
        background-color: #f0f7ff;
      }

      /* Status Messages */
      .status-message {
        padding: 12px 16px;
        border-radius: 8px;
        margin: 16px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-error {
        background-color: #ffebee;
        color: var(--error-color);
        border: 1px solid rgba(244, 67, 54, 0.2);
      }

      .status-success {
        background-color: #e8f5e9;
        color: var(--success-color);
        border: 1px solid rgba(76, 175, 80, 0.2);
      }

      /* Missing Data Highlight */
      .missing-data {
        color: var(--error-color);
        font-weight: 500;
      }

      /* No Data Message */
      .no-data {
        padding: 32px;
        text-align: center;
        color: #666;
        font-style: italic;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-sm);
      }

      /* Loading Overlay */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all var(--transition-speed);
      }

      .loading-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .loading-content {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        text-align: center;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 12px;
        }

        .controls {
          padding: 16px;
          gap: 12px;
        }

        .controls select,
        .controls button {
          width: 100%;
        }

        .tab-button {
          padding: 10px 16px;
          font-size: 14px;
        }

        th, td {
          padding: 8px 12px;
          font-size: 13px;
        }
      }

      /* Print Styles */
      @media print {
        body {
          padding: 0;
          background: white;
        }

        .controls,
        .tab-navigation {
          display: none;
        }

        .table-container {
          box-shadow: none;
        }

        table {
          border-collapse: collapse;
        }

        th, td {
          border: 1px solid #000;
        }
      }
    </style>
</head>
<body>
    <h1>Satsang Report by Day</h1>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Loading data...</p>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <label for="monthSelector">Select Month:</label>
        <select id="monthSelector">
            <? if (availableMonths && availableMonths.length > 0) { ?>
                <? availableMonths.forEach(month => { 
                    var displayMonth = month;
                    try {
                        var parts = month.split('-');
                        var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
                        displayMonth = date.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
                    } catch(e) {}
                ?>
                    <option value="<?= month ?>" <?= month === selectedMonth ? 'selected' : '' ?>><?!= displayMonth ?></option>
                <? }) ?>
            <? } else if (selectedMonth) { ?>
                <? var displayMonth = selectedMonth;
                   try {
                       var parts = selectedMonth.split('-');
                       var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1);
                       displayMonth = date.toLocaleDateString(undefined, { month: 'short', year: 'numeric' });
                   } catch(e) {}
                ?>
                    <option value="<?= selectedMonth ?>" selected><?!= displayMonth ?> (No Data)</option>
            <? } else { ?>
                <option value="" disabled selected>-- No Months Available --</option>
            <? } ?>
        </select>
        <button id="exportButton" <?!= !selectedMonth ? 'disabled' : '' ?>>
            <span class="button-text">Export Avg Sangat</span>
        </button>
        <button id="copyMissingButton" <?!= !selectedMonth ? 'disabled' : '' ?>>
            <span class="button-text">Copy Missing Dates</span>
        </button>
        <button id="filterIncompleteButton" <?!= !selectedMonth ? 'disabled' : '' ?>>
            <span class="button-text">Show Incomplete Only</span>
        </button>
        <button id="exportCompleteButton">
            <span class="button-text">Export Complete Report</span>
        </button>
        <span id="exportStatus"></span>
        <span id="copyStatus"></span>
        <span id="filterIncompleteStatus" style="margin-left: 5px; margin-right: 5px;"></span>
        <span id="exportCompleteStatus"></span>
    </div>

    <? if (error) { ?>
        <div class="status-message status-error">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM11 15H9V13H11V15ZM11 11H9V5H11V11Z" fill="currentColor"/>
            </svg>
            Error loading dashboard: <?= error ?>
        </div>
    <? } else if (!selectedMonth) { ?>
        <div class="status-message">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM11 15H9V13H11V15ZM11 11H9V5H11V11Z" fill="currentColor"/>
            </svg>
            Please select a month, or add data to the sheet.
        </div>
    <? } else { ?>
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="sunday">Sunday Satsangs</button>
            <button class="tab-button" data-tab="wednesday">Wednesday Satsangs</button>
            <button class="tab-button" data-tab="special">Special Satsangs</button>
        </div>

        <? function generatePivotedTable(title, data, sortedDates, eventDetailHeaders, eventDetailKeys, selectedMonth) { ?>
            <? if (!data || !data.templateData || data.templateData.length === 0) { ?>
                <? var displayMonth = selectedMonth; try { var parts = selectedMonth.split('-'); var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, 1); displayMonth = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' }); } catch(e) {} ?>
                <div class="no-data">No <?= title.toLowerCase() ?> data available for <?= displayMonth ?>.</div>
            <? } else { ?>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sn-header" rowspan="2">S.N.</th>
                                <th class="avg-header" rowspan="2">Avg Sangat</th>
                                <th class="centre-header" rowspan="2">Centre/Subcentre</th>
                                <? if (sortedDates && sortedDates.length > 0) { ?>
                                    <? for (var i = 0; i < sortedDates.length; i++) { ?>
                                        <th class="date-header" colspan="<?= eventDetailHeaders.length ?>"><?= sortedDates[i] ?></th>
                                    <? } ?>
                                <? } ?>
                            </tr>
                            <tr>
                                <? if (sortedDates && sortedDates.length > 0) { ?>
                                    <? for (var d = 0; d < sortedDates.length; d++) { ?>
                                        <? for (var c = 0; c < eventDetailHeaders.length; c++) { ?>
                                            <th class="sub-header"><?= eventDetailHeaders[c] ?></th>
                                        <? } ?>
                                    <? } ?>
                                <? } ?>
                            </tr>
                        </thead>
                        <tbody>
                            <? for (var i = 0; i < data.templateData.length; i++) { var centreRow = data.templateData[i]; ?>
                                <tr>
                                    <td class="sn-cell"><?= i + 1 ?></td>
                                    <td class="avg-cell"><?= centreRow.averageSangat ?></td>
                                    <td class="centre-cell <?= centreRow.isBold ? 'bold-centre' : '' ?><?= centreRow.isMissingData ? ' missing-data' : '' ?>"><?= centreRow.centre ?></td>
                                    <? if (sortedDates && sortedDates.length > 0) { ?>
                                        <? for (var d = 0; d < sortedDates.length; d++) { 
                                            var dateKey = sortedDates[d];
                                            var eventDataForDate = centreRow.dateData[dateKey] || {};
                                        ?>
                                            <? eventDetailKeys.forEach((colKey, index) => {
                                                var displayValue = eventDataForDate[colKey];
                                                displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue;
                                                // Add separator at the start of Total Sangat column
                                                var isTotalSangatColumn = eventDetailHeaders[index] === 'Total Sangat';
                                            ?>
                                                <td class="<?= isTotalSangatColumn ? 'date-separator' : '' ?>"><?= displayValue ?></td>
                                            <? }); ?>
                                        <? } ?>
                                    <? } ?>
                                </tr>
                            <? } ?>
                        </tbody>
                    </table>
                </div>
            <? } ?>
        <? } ?>

        <!-- Sunday Satsangs Tab -->
        <div id="sunday" class="tab-content active">
            <div class="table-controls" style="margin-bottom: 10px; padding: 10px; background-color: #f9f9f9; border-radius: 6px;">
              <label for="sundaySearchInput" style="margin-right: 5px; font-weight: 500;">Search Centre:</label>
              <input type="text" id="sundaySearchInput" placeholder="Type to search..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 250px;">
            </div>
            <? generatePivotedTable('Sunday Satsangs', sundayData, sundayData ? sundayData.sortedDates : [], eventDetailHeaders, eventDetailKeys, selectedMonth); ?>
        </div>

        <!-- Wednesday Satsangs Tab -->
        <div id="wednesday" class="tab-content">
            <?
            // _displayMonth is already prepared at the top of the HTML for "No data" messages.
            // wednesdayData.templateData is now prepared by Code.gs to include all static centers.
            // wednesdayData.sortedDates contains the actual dates for which data was reported in the month.
            ?>
            <? if (!wednesdayData || !wednesdayData.templateData || wednesdayData.templateData.length === 0) { ?>
                <div class="no-data">No Wednesday satsang data available for <?= _displayMonth ?>.</div>
            <? } else if (!wednesdayData.sortedDates || wednesdayData.sortedDates.length === 0) { ?>
                <div class="no-data">No Wednesday satsangs were scheduled or reported for <?= _displayMonth ?>. All configured centers are listed below.</div>
                <!-- Still render the table structure but without date columns if templateData exists -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sn-header">S.N.</th>
                                <th class="avg-header">Avg Sangat</th>
                                <th class="centre-header">Centre/Subcentre</th>
                            </tr>
                        </thead>
                        <tbody>
                            <? for (var i = 0; i < wednesdayData.templateData.length; i++) {
                                var centreRow = wednesdayData.templateData[i];
                            ?>
                                <tr>
                                    <td class="sn-cell"><?= i + 1 ?></td>
                                    <td class="avg-cell"><?= centreRow.averageSangat ?></td>
                                    <td class="centre-cell <?= centreRow.isBold ? 'bold-centre' : '' ?> <?= centreRow.isMissingData ? 'missing-data' : '' ?>"><?= centreRow.centre ?></td>
                                </tr>
                            <? } ?>
                        </tbody>
                    </table>
                </div>
            <? } else { ?>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="sn-header" rowspan="2">S.N.</th>
                                <th class="avg-header" rowspan="2">Avg Sangat</th>
                                <th class="centre-header" rowspan="2">Centre/Subcentre</th>
                                <? for (var i = 0; i < wednesdayData.sortedDates.length; i++) { ?>
                                    <th class="date-header" colspan="<?= eventDetailHeaders.length ?>"><?= wednesdayData.sortedDates[i] ?></th>
                                <? } ?>
                            </tr>
                            <tr>
                                <? for (var d = 0; d < wednesdayData.sortedDates.length; d++) { ?>
                                    <? for (var c = 0; c < eventDetailHeaders.length; c++) { ?>
                                        <th class="sub-header"><?= eventDetailHeaders[c] ?></th>
                                    <? } ?>
                                <? } ?>
                            </tr>
                        </thead>
                        <tbody>
                            <? for (var i = 0; i < wednesdayData.templateData.length; i++) {
                                var centreRow = wednesdayData.templateData[i];
                                // The isMissingData flag is now set by Code.gs
                            ?>
                                <tr>
                                    <td class="sn-cell"><?= i + 1 ?></td>
                                    <td class="avg-cell"><?= centreRow.averageSangat ?></td>
                                    <td class="centre-cell <?= centreRow.isBold ? 'bold-centre' : '' ?> <?= centreRow.isMissingData ? 'missing-data' : '' ?>"><?= centreRow.centre ?></td>
                                    <? for (var d = 0; d < wednesdayData.sortedDates.length; d++) {
                                        var dateKey = wednesdayData.sortedDates[d];
                                        var eventDataForDate = centreRow.dateData[dateKey] || {}; // Default to empty object if no data for this specific date
                                        eventDetailKeys.forEach(function(colKey, index) {
                                            var displayValue = eventDataForDate[colKey];
                                            displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue;
                                            var isTotalSangatColumn = eventDetailHeaders[index] === 'Total Sangat';
                                    ?>
                                        <td class="<?= isTotalSangatColumn ? 'date-separator' : '' ?>"><?= displayValue ?></td>
                                    <? }); } ?>
                                </tr>
                            <? } ?>
                        </tbody>
                    </table>
                </div>
            <? } ?>
        </div>

        <!-- Special Satsangs Tab -->
        <div id="special" class="tab-content">
            <? if (!_specialData || _specialData.length === 0) { ?>
                <div class="no-data">No special satsang data available for <?= _displayMonth ?>.</div>
            <? } else if (!_headers || _headers.length === 0 || !_keys || _keys.length === 0) { ?>
                <div class="status-message status-error">Error: Special Satsang table configuration is missing. Cannot display data.</div>
            <? } else { ?>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <? _headers.forEach(header => { ?>
                                    <th><?= header ?></th>
                                <? }); ?>
                            </tr>
                        </thead>
                        <tbody>
                            <? _specialData.forEach(event => { ?>
                                <tr>
                                    <? _keys.forEach(key => {
                                        var displayValue = event[key];
                                        displayValue = (displayValue === null || displayValue === undefined) ? '' : displayValue;
                                    ?>
                                        <td><?= displayValue ?></td>
                                    <? }); ?>
                                </tr>
                            <? }); ?>
                        </tbody>
                    </table>
                </div>
            <? } ?>
        </div>
    <? } ?>

    <script>
      // Show loading overlay
      function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
      }

      // Hide loading overlay
      function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
      }

      // Add loading state to buttons
      function setButtonLoading(buttonId, isLoading) {
        const button = document.getElementById(buttonId);
        const buttonText = button.querySelector('.button-text');
        
        if (isLoading) {
          button.disabled = true;
          buttonText.innerHTML = '<div class="loading-spinner"></div> Loading...';
        } else {
          button.disabled = false;
          buttonText.textContent = buttonText.getAttribute('data-original-text') || buttonText.textContent;
        }
      }

      // Store original button text
      document.querySelectorAll('button').forEach(button => {
        const buttonText = button.querySelector('.button-text');
        if (buttonText) {
          // Ensure filterIncompleteButton's original text is correctly captured if it's dynamic later
          if (button.id === 'filterIncompleteButton') {
            buttonText.setAttribute('data-original-text', "Show Incomplete Only");
          } else {
            buttonText.setAttribute('data-original-text', buttonText.textContent);
          }
        }
      });

      // Tab switching with animation
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons and contents
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          // Add active class to clicked button and corresponding content
          button.classList.add('active');
          const tabId = button.getAttribute('data-tab');
          document.getElementById(tabId).classList.add('active');
        });
      });

      // Month change handler with loading state
      document.getElementById('monthSelector').addEventListener('change', function() {
        showLoading(); // Global loading overlay
        clearGlobalError(); // Clear previous global errors
        // Clear all button status messages
        ['exportStatus', 'copyStatus', 'exportCompleteStatus', 'filterIncompleteStatus'].forEach(id => {
            const span = document.getElementById(id);
            if (span) {
                span.textContent = '';
                span.className = ''; // Reset class to remove status styling
            }
        });
        // Clear Sunday search input
        const sundaySearch = document.getElementById('sundaySearchInput');
        if (sundaySearch) {
            sundaySearch.value = '';
            // Optionally trigger filter to reset view, though page reload will handle it
        }


        const selectedMonth = this.value;
        
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.error) {
              showError(result.error); // Show new global error if any from server logic
            } else {
              location.reload(); // Reload page to reflect new month's data
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showError(error); // Show global error on failure to change month
          })
          .changeMonth(selectedMonth);
      });

      // Export handlers with loading states
      function handleExport(buttonId, statusId, exportFunction) {
        const button = document.getElementById(buttonId);
        const statusSpan = document.getElementById(statusId);
        const selectedMonth = document.getElementById('monthSelector').value;
        
        // Clear previous status for this specific button
        statusSpan.textContent = '';
        statusSpan.className = ''; // Reset class

        if (!selectedMonth) {
          statusSpan.textContent = 'Please select a month first.';
          statusSpan.className = 'status-message status-error';
          return;
        }

        setButtonLoading(buttonId, true);
        statusSpan.textContent = 'Preparing export...';
        statusSpan.className = 'status-message'; // Neutral class while loading

        google.script.run
          .withSuccessHandler(function(downloadUrl) {
            setButtonLoading(buttonId, false);
            if (downloadUrl) {
              statusSpan.textContent = 'Export successful! Downloading...';
              statusSpan.className = 'status-message status-success';
              window.open(downloadUrl, '_blank');
            } else {
              // This case might mean no data to export, or an issue generating the URL server-side without throwing an error.
              statusSpan.textContent = 'Export completed, but no download URL was provided. This may happen if there is no data for the selected month or criteria.';
              statusSpan.className = 'status-message'; // Use neutral for this, or status-error if preferred
            }
          })
          .withFailureHandler(function(error) {
            setButtonLoading(buttonId, false);
            const userErrorMessage = getUserFriendlyErrorMessage(error);
            statusSpan.textContent = userErrorMessage;
            statusSpan.className = 'status-message status-error';
            console.error('Export Error (' + exportFunction + '):', error);
          })
          [exportFunction](selectedMonth);
      }

      // Add event listeners for export buttons
      document.getElementById('exportButton').addEventListener('click', () => 
        handleExport('exportButton', 'exportStatus', 'exportFilteredDataToExcel'));
      
      document.getElementById('exportCompleteButton').addEventListener('click', () => 
        handleExport('exportCompleteButton', 'exportCompleteStatus', 'exportCompleteDataToExcel'));

      // Handler for Copy Missing Dates button
      function handleCopyMissingDates() {
        const buttonId = 'copyMissingButton';
        const statusId = 'copyStatus';
        const statusSpan = document.getElementById(statusId);
        const selectedMonth = document.getElementById('monthSelector').value;

        // Clear previous status for this specific button
        statusSpan.textContent = '';
        statusSpan.className = '';


        if (!selectedMonth) {
          statusSpan.textContent = 'Please select a month first.';
          statusSpan.className = 'status-message status-error';
          return;
        }

        setButtonLoading(buttonId, true);
        statusSpan.textContent = 'Finding missing dates...';
        statusSpan.className = 'status-message'; // Neutral class while loading

        google.script.run
          .withSuccessHandler(function(results) {
            setButtonLoading(buttonId, false);
            if (results && results.length > 0) {
              let formattedResults = "";
              results.forEach(item => {
                formattedResults += `${item.centerName} (${item.day}): ${item.dates.join(', ')}\n`;
              });

              const textArea = document.createElement('textarea');
              textArea.value = formattedResults;
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand('copy');
                statusSpan.textContent = 'Missing dates copied to clipboard!';
                statusSpan.className = 'status-message status-success';
              } catch (err) {
                console.error('Error copying to clipboard:', err);
                const userErrorMessage = getUserFriendlyErrorMessage(err); // Use helper for clipboard error too
                statusSpan.textContent = 'Failed to copy to clipboard. ' + userErrorMessage;
                statusSpan.className = 'status-message status-error';
              }
              document.body.removeChild(textArea);

            } else {
              statusSpan.textContent = 'No missing dates found for the selected month.';
              statusSpan.className = 'status-message'; // Neutral, not an error
            }
          })
          .withFailureHandler(function(error) {
            setButtonLoading(buttonId, false);
            const userErrorMessage = getUserFriendlyErrorMessage(error);
            statusSpan.textContent = userErrorMessage;
            statusSpan.className = 'status-message status-error';
            console.error('Error finding missing dates:', error);
          })
          .findMissingDateEntries(selectedMonth);
      }

      // Add event listener for Copy Missing Dates button
      document.getElementById('copyMissingButton').addEventListener('click', handleCopyMissingDates);

      // Client-side filtering for incomplete data
      const filterIncompleteButton = document.getElementById('filterIncompleteButton');
      let showingIncompleteOnly = false; // State variable

      if (filterIncompleteButton) {
        filterIncompleteButton.addEventListener('click', function() {
          showingIncompleteOnly = !showingIncompleteOnly;
          const buttonTextSpan = this.querySelector('.button-text');
          const statusSpan = document.getElementById('filterIncompleteStatus');
          statusSpan.textContent = ''; // Clear previous status
          statusSpan.className = '';

          // Determine active tab to get the correct table
          const activeTabButton = document.querySelector('.tab-button.active');
          if (!activeTabButton) return; // Should not happen

          const activeTabId = activeTabButton.getAttribute('data-tab');
          let tableBody;
          let tableBodySelector;

          if (activeTabId === 'sunday') {
            tableBody = document.querySelector("#sunday .table-container table tbody");
            tableBodySelector = "#sunday .table-container table tbody";
          } else if (activeTabId === 'wednesday') {
            tableBody = document.querySelector("#wednesday .table-container table tbody");
            tableBodySelector = "#wednesday .table-container table tbody";
          } else {
            statusSpan.textContent = 'Filtering not applicable to this tab.';
            statusSpan.className = 'status-message'; // Neutral
            // Revert state if button was clicked on an unsupported tab
            showingIncompleteOnly = !showingIncompleteOnly;
            return;
          }

          if (!tableBody) {
            statusSpan.textContent = 'Table not found for filtering.';
            statusSpan.className = 'status-message status-error';
            showingIncompleteOnly = !showingIncompleteOnly; // Revert state
            return;
          }

          const rows = tableBody.getElementsByTagName('tr');
          let visibleRowCount = 0;

          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const centreCell = row.querySelector("td.centre-cell"); // Centre cell that might have 'missing-data' class

            if (showingIncompleteOnly) {
              if (centreCell && centreCell.classList.contains('missing-data')) {
                row.style.display = "";
                visibleRowCount++;
              } else {
                row.style.display = "none";
              }
            } else {
              // When showing all, also respect the main search filter if active
              const sundaySearchVal = document.getElementById('sundaySearchInput') ? document.getElementById('sundaySearchInput').value.toLowerCase() : "";
              if (activeTabId === 'sunday' && sundaySearchVal !== "") {
                  const centreName = centreCell ? centreCell.textContent.toLowerCase() : "";
                  if (centreName.includes(sundaySearchVal)) {
                      row.style.display = "";
                      visibleRowCount++;
                  } else {
                      row.style.display = "none";
                  }
              } else {
                  row.style.display = ""; // Show all if not Sunday tab with active search
                  visibleRowCount++;
              }
            }
          }

          if (showingIncompleteOnly) {
            buttonTextSpan.textContent = 'Show All Centres';
            statusSpan.textContent = `Showing ${visibleRowCount} incomplete entries.`;
            statusSpan.className = 'status-message';
          } else {
            buttonTextSpan.textContent = 'Show Incomplete Only';
            statusSpan.textContent = 'Showing all entries.';
             statusSpan.className = 'status-message';
          }

          if (visibleRowCount === 0 && showingIncompleteOnly) {
             statusSpan.textContent = 'No incomplete entries found.';
          } else if (visibleRowCount === 0 && !showingIncompleteOnly){
            // This case should ideally be handled by the "No data" message of the table itself.
            // statusSpan.textContent = 'No entries to display.';
          }


          updateSerialNumbers(tableBodySelector);
        });
      }


      // Function to update serial numbers for visible rows
      function updateSerialNumbers(tableBodySelector) {
        const tableBody = document.querySelector(tableBodySelector);
        if (!tableBody) return;

        const visibleRows = tableBody.querySelectorAll("tr:not([style*='display: none'])");
        visibleRows.forEach((row, index) => {
          const snCell = row.querySelector("td.sn-cell"); // Assuming S.N cell has class 'sn-cell'
          if (snCell) {
            snCell.textContent = index + 1;
          }
        });
      }

      // Event listener for Sunday Search Input
      const sundaySearchInput = document.getElementById('sundaySearchInput');
      if (sundaySearchInput) {
        sundaySearchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const sundayTableBody = document.querySelector("#sunday .table-container table tbody");

          // If "Show Incomplete Only" is active, we need to respect that filter as well
          const filterIncompleteActive = showingIncompleteOnly;

          if (sundayTableBody) {
            const rows = sundayTableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              const centreCell = row.querySelector("td.centre-cell");
              let showRow = false;
              if (centreCell) {
                const centreName = centreCell.textContent.toLowerCase();
                const meetsSearchCriteria = centreName.includes(searchTerm);
                const isIncomplete = centreCell.classList.contains('missing-data');

                if (filterIncompleteActive) {
                  if (meetsSearchCriteria && isIncomplete) {
                    showRow = true;
                  }
                } else {
                  if (meetsSearchCriteria) {
                    showRow = true;
                  }
                }
              }
              row.style.display = showRow ? "" : "none";
            }
            updateSerialNumbers("#sunday .table-container table tbody");
          }
        });
      }

      // Generic utility to get user-friendly error messages
      function getUserFriendlyErrorMessage(error) {
        let message = "An unexpected error occurred. Please try again later.";
        if (error && error.message) {
          // Apps Script specific errors often have "Exception:" or "ScriptError:" prefix
          let detailedMessage = error.message.replace(/^Exception: /i, "").replace(/^ScriptError: /i, "");

          if (detailedMessage.includes("Timed out")) {
            message = "The operation timed out. The server may be busy or the request took too long. Please try again.";
          } else if (detailedMessage.match(/not found/i) || detailedMessage.match(/getSheetByName/i)) {
            message = "A required resource (e.g., a sheet or configuration) was not found. Please check your spreadsheet setup. Details: " + detailedMessage;
          } else if (detailedMessage.includes("Service Spreadsheets failed")) {
            message = "A data processing error occurred with Google Sheets. This could be due to issues like invalid characters in your data, unusual cell formatting, or very large numbers/text. Details: " + detailedMessage;
          } else if (detailedMessage.match(/permission/i) || detailedMessage.match(/access denied/i)) {
            message = "Permission denied. Please ensure the script has the necessary permissions and check your Google account. Details: " + detailedMessage;
          } else if (detailedMessage.trim().length > 0) {
            message = "Error: " + detailedMessage;
          }
        } else if (typeof error === 'string' && error.trim().length > 0) {
          message = error; // If error is just a non-empty string
        }
        return message;
      }

      // Global error display (for non-button specific errors like month change)
      function showError(error) { // Accepts error object or string
        const message = getUserFriendlyErrorMessage(error);
        const existingErrorDiv = document.getElementById('globalErrorDiv');
        if (existingErrorDiv) {
          existingErrorDiv.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM11 15H9V13H11V15ZM11 11H9V5H11V11Z" fill="currentColor"/>
            </svg>
            ${message}
          `;
          existingErrorDiv.style.display = 'flex'; // Make sure it's visible
        } else {
          const errorDiv = document.createElement('div');
          errorDiv.id = 'globalErrorDiv';
          errorDiv.className = 'status-message status-error'; // It's always an error
          errorDiv.style.display = 'flex';
          errorDiv.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 0C4.48 0 0 4.48 0 10C0 15.52 4.48 20 10 20C15.52 20 20 15.52 20 10C20 4.48 15.52 0 10 0ZM11 15H9V13H11V15ZM11 11H9V5H11V11Z" fill="currentColor"/>
            </svg>
            ${message}
          `;
          // Insert after the .controls div, or a more specific location if desired
          const controlsDiv = document.querySelector('.controls');
          if (controlsDiv && controlsDiv.parentNode) {
            controlsDiv.parentNode.insertBefore(errorDiv, controlsDiv.nextSibling);
          } else { // Fallback if .controls is not found
            document.body.insertBefore(errorDiv, document.body.firstChild);
          }
        }
      }

      function clearGlobalError() {
        const existingErrorDiv = document.getElementById('globalErrorDiv');
        if (existingErrorDiv) {
          existingErrorDiv.style.display = 'none';
          existingErrorDiv.innerHTML = ''; // Clear content
        }
      }

      // Add error handling for script loading
      window.onerror = function(msg, url, lineNo, columnNo, error) {
        console.error('Script Error:', msg, 'at', url, ':', lineNo);
        return false;
      };
    </script>
</body>
</html>